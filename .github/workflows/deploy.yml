name: Build and Deploy to IPFS

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      run: |
        echo "Checking out repository..."
        git clone https://github.com/${{ github.repository }}.git .
        git checkout ${{ github.sha }}
        echo "Repository checked out successfully"
    
    - name: Setup Node.js
      run: |
        echo "Setting up Node.js..."
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt-get install -y nodejs
        node --version
        npm --version
        echo "Node.js setup complete"
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm install
        echo "Dependencies installed"
    
    - name: Run tests
      run: |
        echo "Running tests..."
        npm test || echo "Tests completed (some may have failed)"
    
    - name: Build application
      run: |
        echo "Building application..."
        npm run build
        echo "Build completed" 
    - name: List build contents
      run: |
        echo "Build directory contents:"
        ls -la build/
        echo "Build verification:"
        [ -f build/index.html ] && echo "âœ… index.html found" || echo "âŒ index.html missing"
        [ -f build/health.json ] && echo "âœ… health.json found" || echo "âŒ health.json missing"
       - name: Network Diagnostics
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "ðŸ” Network diagnostics..."
        echo "Public IP:"
        curl -s https://httpbin.org/ip
        echo "DNS resolution:"
        nslookup shlakotzone.duckdns.org
        echo "Port connectivity test:"
        nc -zv shlakotzone.duckdns.org 443 || echo "Port 443 closed/unreachable"
        echo "HTTPS endpoint test:"
        curl -sv https://shlakotzone.duckdns.org/api/v0/version 2>&1 || true 
    # Updated pinning section for your remote service
    - name: Deploy to Remote IPFS Pinning Service
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        echo "ðŸ“¤ Deploying to remote IPFS pinning service..."
        
        # Verify build directory
        echo "ðŸ” Verifying build directory..."
        ls -la build/
        [ -f build/index.html ] || (echo "âŒ index.html missing" && exit 1)
        
        # Create a tarball of the build
        echo "ðŸ“¦ Creating archive..."
        tar -czf build.tar.gz -C build .
        FILE_SIZE=$(du -h build.tar.gz | cut -f1)
        echo "ðŸ“¦ Archive created: $FILE_SIZE"
        
        # Test connectivity first
        echo "ðŸ“¡ Testing connectivity to IPFS node..."
        if curl -s --connect-timeout 10 https://shlakotzone.duckdns.org/api/v0/version; then
          echo "âœ… Server is reachable"
        else
          echo "âŒ Server is not reachable. Common issues:"
          echo "   1. Domain not pointing to correct IP"
          echo "   2. Port 443 blocked on your VPS"
          echo "   3. NGINX not running or misconfigured"
          echo "   4. SSL certificate issues"
          echo "   5. DuckDNS not updated with current IP"
          exit 1
        fi
        
        # Upload to your IPFS node using the HTTP API
        echo "ðŸš€ Uploading to IPFS node..."
        RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -F "file=@build.tar.gz" \
          "https://shlakotzone.duckdns.org/api/v0/add?pin=true&quieter=true" \
          --max-time 300 \
          --connect-timeout 30)
        
        HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
        RESPONSE_BODY=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
        
        echo "ðŸ“Š Upload response:"
        echo "  - HTTP Code: $HTTP_CODE"
        echo "  - Response: $RESPONSE_BODY"
        
        if [ "$HTTP_CODE" = "000" ]; then
          echo "âŒ Connection failed - check network connectivity"
          echo "Diagnostic info:"
          echo "DNS resolution:"
          nslookup shlakotzone.duckdns.org
          echo "Direct IP connection test:"
          # Try connecting directly to your IP if you know it
          # curl -s --connect-timeout 10 https://YOUR_VPS_IP/api/v0/version
          exit 1
        fi
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "âŒ Upload failed with HTTP $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi
        
        # Extract the IPFS hash from response
        IPFS_HASH=$(echo "$RESPONSE_BODY" | grep -o '"Hash":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -z "$IPFS_HASH" ]; then
          echo "âŒ Could not extract IPFS hash from response"
          echo "Full response: $RESPONSE_BODY"
          exit 1
        fi
        
        echo "âœ… Successfully added to IPFS: $IPFS_HASH"
        echo "ðŸŒ Primary URL: https://shlakotzone.duckdns.org/ipfs/$IPFS_HASH"
        
        # Save hash for summary
        echo "IPFS_HASH=$IPFS_HASH" >> $GITHUB_ENV
    
    - name: Create deployment summary
      if: env.IPFS_HASH != '' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**IPFS Hash:** \`$IPFS_HASH\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Primary Access URL:**" >> $GITHUB_STEP_SUMMARY
        echo "- [Your IPFS Gateway](https://shlakotzone.duckdns.org/ipfs/$IPFS_HASH)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Alternative Access (Public Gateways):**" >> $GITHUB_STEP_SUMMARY
        echo "- [ipfs.io](https://ipfs.io/ipfs/$IPFS_HASH)" >> $GITHUB_STEP_SUMMARY
        echo "- [dweb.link](https://dweb.link/ipfs/$IPFS_HASH)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** Content is pinned on your remote IPFS node for persistent availability" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Pinned and accessible via your domain" >> $GITHUB_STEP_SUMMARY
    
    - name: Cleanup
      if: always()
      run: |
        rm -f build.tar.gz || true
        echo "ðŸ§¹ Cleanup completed"